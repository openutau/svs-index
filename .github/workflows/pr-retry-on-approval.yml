name: Retry Submission PR on Approval

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  retry-on-approval:
    # Only run when the review is an approval and the PR has the `submission` label
    if: github.event.review.state == 'approved' && contains(github.event.pull_request.labels.*.name, 'submission')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.12.0'

      - name: Install dependencies
        run: |
          npm ci
          npm install --no-save ajv ajv-formats relaxed-json

      - name: Retry recreate-and-push loop
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          max_attempts=10
          attempt=1
          backoff=10
          multiplier=2

          echo "Starting retry loop for PR #${PR_NUMBER} -> branch ${PR_BRANCH}"

          while [ $attempt -le $max_attempts ]; do
            echo "--- Attempt ${attempt}/${max_attempts} ---"
            git fetch origin main
            git checkout -B retry-${PR_NUMBER}-${attempt} origin/main

            # Determine original issue number from branch name (submission-<num>) or PR body (Closes #<num>),
            # then fetch that issue and create an event payload so `scripts/process-issue.js` uses the original issue data.
            ISSUE_NUMBER_FROM_BRANCH=""
            if [[ "${PR_BRANCH}" =~ submission-([0-9]+)$ ]]; then
              ISSUE_NUMBER_FROM_BRANCH="${BASH_REMATCH[1]}"
            fi

            ISSUE_NUMBER_TO_USE=""
            if [ -n "${ISSUE_NUMBER_FROM_BRANCH}" ]; then
              ISSUE_NUMBER_TO_USE="${ISSUE_NUMBER_FROM_BRANCH}"
            else
              ISSUE_NUMBER_TO_USE=$(echo "${PR_BODY}" | node -e "const s=require('fs').readFileSync(0,'utf8'); const m=s.match(/#[0-9]+/); if(m) console.log(m[0].replace('#',''));")
            fi
            if [ -z "${ISSUE_NUMBER_TO_USE}" ]; then
              echo "Could not locate original issue number; aborting automated retry."
              curl -s -S -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" -d "{\"body\":\"❌ Automated retry aborted: could not determine original submission issue number. Ensure the submission branch is named 'submission-<issue>' or the PR body contains 'Closes #<issue>'.\"}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments"
              curl -s -S -X POST -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" -d "{\"labels\":[\"needs-original-issue\"]}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/labels" || true
              exit 1
            fi

            echo "Using original issue number: ${ISSUE_NUMBER_TO_USE}"

            curl -sS -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER_TO_USE}" | \
              node -e "const fs=require('fs');let s='';process.stdin.on('data',c=>s+=c);process.stdin.on('end',()=>{const p=JSON.parse(s||'{}');fs.writeFileSync('pr_event.json',JSON.stringify({issue:{number:p.number||0,title:p.title||'',body:p.body||''},repository:{full_name:process.env.GITHUB_REPOSITORY||''}}));});"
            export GITHUB_EVENT_PATH="$PWD/pr_event.json"

            # Run the same processing script used for issues; it will write the data files
            if node scripts/process-issue.js; then
              # If the script produced changes, commit them
              git add -A || true
              if git diff --cached --quiet; then
                echo "No changes produced by processing; nothing to push. Posting status and exiting."
                curl -s -S -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" -d "{\"body\":\"✅ Retry attempt ${attempt}: no changes were necessary.\"}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments"
                exit 0
              fi

              git commit -m "Reapply submission from PR #${PR_NUMBER} (retry attempt ${attempt})" || true

              echo "Pushing recreated branch to update PR branch ${PR_BRANCH} (force)"
              if git push --force origin HEAD:"${PR_BRANCH}"; then
                curl -s -S -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" -d "{\"body\":\"✅ Retry attempt ${attempt} succeeded: PR branch rebased and updated.\"}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments"
                exit 0
              else
                echo "Push failed on attempt ${attempt}"
              fi
            else
              echo "scripts/process-issue.js failed on attempt ${attempt}"
            fi

            # cleanup local retry branch and prepare for next attempt
            git checkout main || true
            git branch -D retry-${PR_NUMBER}-${attempt} || true

            echo "Sleeping ${backoff}s before next attempt"
            sleep ${backoff}
            backoff=$((backoff * multiplier))
            attempt=$((attempt + 1))
          done

          # All attempts failed - notify and add label for manual intervention
          curl -s -S -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" -d "{\"body\":\"❌ Automated retry failed after ${max_attempts} attempts. Please rebase manually or ask maintainers to assist. Labeling as needs-rebase.\"}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments"

          curl -s -S -X POST -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" -d "{\"labels\":[\"needs-rebase\"]}" "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/labels" || true

          exit 1
